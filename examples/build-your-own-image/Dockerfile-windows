# Official Microsoft Windows Server Image
FROM mcr.microsoft.com/windows/server:ltsc2022

# -------------------------------
# Handle LabVIEW year properly
# -------------------------------
# ARG is for build-time (can be overridden with --build-arg)
# ENV makes it available inside RUN and in the container
ARG LV_YEAR=2020
ARG LV_FEED_LOCATION=
ARG LV_CORE_PACKAGE=ni-labview-2020-core-en
ARG LV_CLI_PACKAGE=ni-labview-command-line-interface-x86
ARG LV_CLI_PORT=3366
ARG INSTALL_OPTIONAL_HELP=0
ARG DEFER_LV_INSTALL=0
ENV LV_YEAR=${LV_YEAR}
ENV LV_FEED_LOCATION=${LV_FEED_LOCATION}
ENV LV_CORE_PACKAGE=${LV_CORE_PACKAGE}
ENV LV_CLI_PACKAGE=${LV_CLI_PACKAGE}
ENV LV_CLI_PORT=${LV_CLI_PORT}
ENV INSTALL_OPTIONAL_HELP=${INSTALL_OPTIONAL_HELP}
ENV DEFER_LV_INSTALL=${DEFER_LV_INSTALL}

# Configure PowerShell for automated LabVIEW installation
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Continue'; $ProgressPreference = 'SilentlyContinue'; \
      $ConfirmPreference = 'None'; $VerbosePreference = 'Continue'; $WarningPreference = 'Continue';"]

# Make Directory for temporarily storing the installers
RUN New-Item -ItemType Directory -Path 'C:\\ni\\resources' -Force

# Copy NIPKG installer to the image
COPY ["Resources/Windows Resources", "C:/ni/resources/"]

# Install NIPKG Manager
RUN Start-Process -wait C:\\ni\\resources\\install.exe -ArgumentList '--passive', \
    '--accept-eulas',    \
    '--no-shortcuts',    \
    '--no-start-menu',   \
    '--no-desktop-icon', \
    '--no-update-check', \
    '--prevent-reboot'

# Add NIPKG In Path
RUN $nipkgPath = 'C:\Program Files\National Instruments\NI Package Manager'; \
    $machinePath = [Environment]::GetEnvironmentVariable('Path', 'Machine'); \
    if ($machinePath -notlike ('*' + $nipkgPath + '*')) { \
      [Environment]::SetEnvironmentVariable('Path', ($machinePath + ';' + $nipkgPath), 'Machine') \
    }
ENV NIPKG_EXE=C:\\Program Files\\National Instruments\\NI Package Manager\\nipkg.exe

# Fast path installs in Docker build. Resumable path sets DEFER_LV_INSTALL=1 and executes the same installer in runtime phases.
RUN if ($env:DEFER_LV_INSTALL -eq '1') { \
      Write-Host 'DEFER_LV_INSTALL=1, skipping LabVIEW package install during Docker build.'; \
    } else { \
      if ([string]::IsNullOrWhiteSpace($env:LV_FEED_LOCATION)) { \
        throw 'LV_FEED_LOCATION build arg is required when DEFER_LV_INSTALL=0.' \
      }; \
      & 'C:\ni\resources\Install-LV2020x64.ps1' -PersistRoot 'C:\lv-persist'; \
      if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }; \
      if (Test-Path -Path 'C:\ni\resources') { \
        Remove-Item -Path 'C:\ni\resources' -Recurse -Force \
      } \
    }
